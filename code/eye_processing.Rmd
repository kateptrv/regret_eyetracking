---
title: "eye_processing"
author: "Kate Petrova"
date: "2025-08-05"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE)

if(!suppressWarnings(require(pacman))){install.packages("pacman");library("pacman")}
p_load(tidyverse, tidyr, dplyr, ggplot2, stats, sjPlot, readr, ggpubr, patchwork, lubridate, ggthemr, ggdist, showtext, eyelinkReader, usethis, data_table, png, grid)
```

```{r}
ggthemr("fresh")
```

```{r}
usethis::edit_r_environ()
```

```{r}
getwd()
```

# Single participant

```{r}
test <- read_edf('../experiment/data/903406_regret_experiment_2025-08-06_16h07.51.977.EDF')
```

```{r}
#View(test$saccades)
plot(test, trial = NULL, show_fixations = TRUE, show_saccades = FALSE) +
    coord_cartesian(xlim = c(0, 1920), ylim = c(0, 1080)) +
  scale_y_reverse() 
```

```{r}
sac  <- as.data.table(test$saccades)    
msg  <- as.data.table(test$events)          

msg <- msg[type == "MESSAGEEVENT" & grepl("^(FIX|CHOICE|FEEDBACK|REGRET)", message),
           .(trial, msg_time = sttime_rel, label = message)]

msg <- msg |>
    mutate(
    trial_num = as.numeric(stringr::str_extract(label, "\\d+")),
    type = case_when(
      grepl("^FIX", label) ~ "fixation",
      grepl("^CHOICE", label) ~ "choice",
      grepl("^FEEDBACK", label) ~ "feedback",
      grepl("^REGRET", label) ~ "regret",
      TRUE ~ NA_character_  
    )
  ) |>
  arrange(msg_time) |> 
  fill(type, trial_num, .direction = "down")

sac[, `:=`(start = sttime_rel, end = entime_rel)]
msg[, `:=`(start = msg_time, end = msg_time)]

setkey(msg, start, end)
setkey(sac, start, end)
                     
sac_labeled <- msg[sac, on = .(trial, start), roll = TRUE]


```


```{r}
# Basic bubble plot
sac_labeled |>
  filter(!is.na(type)) |>
ggplot(aes(x = genx, y = geny, size = duration, color = type)) +
  coord_cartesian(xlim = c(0, 1600), ylim = c(0, 1200), expand = FALSE) +
  geom_point(aes(500, 600), shape = 18, size = 4, color = "black") +
  geom_point(aes(800, 600), shape = 18, size = 4, color = "black") +
  geom_point(aes(1100, 600), shape = 18, size = 4, color = "black") +
  geom_point(alpha = 0.5) +
  labs(
    title = "Saccade start points",
    x = "X (pixels)", y = "Y (pixels)", size = "Duration (ms)") +
  theme(legend.position = "none") +
  facet_wrap(~ type)

# NOTE: need to figure out why there appears to be a slight misallignment from the center
```

# Whole sample -- IGNORE FOR NOW
```{r}
edf_files <- list.files("../data", pattern = "\\.EDF$", full.names = TRUE)

# extract participant IDs
get_pid <- function(path) {
  stringr::str_extract(basename(path), "^\\d{6}")
}

edf_data_list <- edf_files |>
  set_names(get_pid) |>
  map(~ read_edf(.x))

```


