g---
title: "eye_processing"
author: "Kate Petrova"
date: "2025-08-05"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE)

if(!suppressWarnings(require(pacman))){install.packages("pacman");library("pacman")}
p_load(tidyverse, tidyr, dplyr, ggplot2, stats, sjPlot, readr, ggpubr, patchwork, lubridate, ggthemr, ggdist, showtext, eyelinkReader, usethis, data.table, png, grid, purrr)
```

```{r}
# setting the theme for plots
ggthemr("fresh")
```

```{r}
# only run the first time you are using the eyelinkReader package
#usethis::edit_r_environ()
```

```{r}
# check that you are in the github directory
getwd()
```

# Single participant

```{r}
# upload data
test <- read_edf('../experiment/data/734722_regret_experiment_2025-08-07_10h53.41.207.EDF')
```

```{r}
# plot fixations using the eyelinkReader native plotting function (does not separate by routine)
plot(test, trial = NULL, show_fixations = TRUE, show_saccades = FALSE) +
    coord_cartesian(xlim = c(0, 1728), ylim = c(0, 1080)) +
  geom_vline(xintercept = 1728/2) +
  geom_hline(yintercept = 1080/2) +
  scale_y_reverse() 
```
## Data processing 

```{r}
msg  <- as.data.table(test$events)   
sac  <- as.data.table(test$saccades)    
fix  <- as.data.table(test$fixations)

msg <- msg[type == "MESSAGEEVENT" & grepl("^(FIX|CHOICE|FEEDBACK|REGRET)", message),
           .(msg_time = sttime_rel, label = message)]

msg <- msg |>
    mutate(
    trial_num = as.numeric(stringr::str_extract(label, "\\d+")),
    type = case_when(
      grepl("^FIX", label) ~ "fixation",
      grepl("^CHOICE", label) ~ "choice",
      grepl("^FEEDBACK", label) ~ "feedback",
      grepl("^REGRET", label) ~ "regret",
      TRUE ~ NA_character_  
    )
  ) |>
  arrange(msg_time) |> 
  fill(type, trial_num, .direction = "down") 

sac <- sac |>
  select(sttime_rel, entime_rel, gstx, gsty, genx, geny, duration) %>% 
  rename_with(~ paste0("sac_", .))

fix <- fix |>
  select(sttime_rel, entime_rel, gstx, gsty, genx, geny, duration) %>% 
  rename_with(~ paste0("fix_", .))
  
sac[, `:=`(start = sac_sttime_rel, end = sac_entime_rel)]
msg[, `:=`(start = msg_time, end = msg_time)]
fix[, `:=`(start = fix_sttime_rel, end = fix_entime_rel)]

setkey(msg, start, end)
setkey(sac, start, end)
setkey(fix, start, end)
                     
sac_labeled <- msg[sac, on = .(start), roll = TRUE]
sac_fix_labeled <- sac_labeled[fix, on = .(start), roll = TRUE]

sac_fix_labeled <- sac_fix_labeled |>
  select(-c(label, start, end, i.end, i.end.1)) |>
  filter(!is.na(msg_time)) 


```

## Data visualization

### Fixations

```{r}
# Basic bubble plot
sac_fix_labeled |>
ggplot(aes(x = fix_gstx, y = fix_gsty, size = fix_duration, color = type)) +
  coord_cartesian(xlim = c(0, 1728), ylim = c(0, 1080), expand = FALSE) +
  scale_y_reverse() +
  # geom_vline(xintercept = 1728/2) +
  # geom_hline(yintercept = 1080/2) +
  geom_point(aes(564, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(864, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(1164, 540), shape = 18, size = 4, color = "black") +
  geom_point(alpha = 0.5) +
  labs(
    title = "Fixation points",
    x = "X (pixels)", y = "Y (pixels)", size = "Duration (ms)") +
  theme(legend.position = "none") +
  facet_wrap(~ type)
```

### Saccades

```{r}
sac_fix_labeled |>
ggplot(aes(x = sac_genx, y = sac_geny, size = sac_duration, color = type)) +
  coord_cartesian(xlim = c(0, 1728), ylim = c(0, 1080), expand = FALSE) +
  scale_y_reverse() +
  # geom_vline(xintercept = 1728/2) +
  # geom_hline(yintercept = 1080/2) +
  geom_point(aes(564, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(864, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(1164, 540), shape = 18, size = 4, color = "black") +
  geom_point(alpha = 0.5) +
  labs(
    title = "Saccades end points",
    x = "X (pixels)", y = "Y (pixels)", size = "Duration (ms)") +
  theme(legend.position = "none") +
  facet_wrap(~ type)

```

# Whole sample

```{r}
edf_files <- list.files("../experiment/data", pattern = "\\.EDF$", full.names = TRUE)
edf_files <- edf_files[file.info(edf_files)$size > 10000]

get_pid <- function(path) str_extract(basename(path), "^\\d{6}")

process_edf <- function(path) {
  pid <- get_pid(path)

  test <- read_edf(path)

  # --- messages ---
  msg <- as.data.table(test$events)[
    type == "MESSAGEEVENT" & grepl("^(FIX|CHOICE|FEEDBACK|REGRET)", message),
    .(msg_time = sttime_rel, label = message)
  ]

  # use dplyr/tidyr to parse labels, then convert back to data.table
  msg <- msg |>
    mutate(
      trial_num = as.numeric(str_extract(label, "\\d+")),
      type = case_when(
        grepl("^FIX", label) ~ "fixation",
        grepl("^CHOICE", label) ~ "choice",
        grepl("^FEEDBACK", label) ~ "feedback",
        grepl("^REGRET", label) ~ "regret",
        TRUE ~ NA_character_
      )
    ) |>
    arrange(msg_time) |>
    fill(type, trial_num, .direction = "down") |>
    as.data.table()

  # add join keys
  msg[, `:=`(start = msg_time, end = msg_time)]
  setkey(msg, start, end)

  # --- saccades ---
  sac <- as.data.table(test$saccades)[, .(
    sac_sttime_rel = sttime_rel, sac_entime_rel = entime_rel,
    sac_gstx = gstx, sac_gsty = gsty, sac_genx = genx, sac_geny = geny,
    sac_duration = duration
  )]
  sac[, `:=`(start = sac_sttime_rel, end = sac_entime_rel)]
  setkey(sac, start, end)

  # --- fixations ---
  fix <- as.data.table(test$fixations)[, .(
    fix_sttime_rel = sttime_rel, fix_entime_rel = entime_rel,
    fix_gstx = gstx, fix_gsty = gsty, fix_genx = genx, fix_geny = geny,
    fix_duration = duration
  )]
  fix[, `:=`(start = fix_sttime_rel, end = fix_entime_rel)]
  setkey(fix, start, end)

  # --- rolling overlap joins: msg → sac → fix ---
  # First label saccades with nearest msg, then fixations with nearest of that result
  sac_labeled <- sac[msg, roll = TRUE]
  labeled     <- fix[sac_labeled, roll = TRUE]

  # keep only rows that got a message label, and attach pid
  out <- labeled[!is.na(msg_time)]
  out[, pid := as.numeric(pid)]

  # ensure trial_num survived (if not, bring from msg columns)
  # already included via join; just sanity-check
  if (!"trial_num" %in% names(out)) out[, trial_num := NA_integer_]

  return(out[])
}

data_eye_processed <- rbindlist(lapply(edf_files, process_edf), fill = TRUE)

# drop safely (only if present)
if ("msg_time" %in% names(data_eye_processed)) data_eye_processed[, msg_time := NULL]

# create trial_index and drop trial_num
if (!"trial_num" %in% names(data_eye_processed)) data_eye_processed[, trial_num := NA_integer_]
data_eye_processed[, trial_index := trial_num][, trial_num := NULL]

# put pid and trial_index first
setcolorder(
  data_eye_processed,
  c("pid", "trial_index", setdiff(names(data_eye_processed), c("pid","trial_index")))
)
``` 
```{r}
# check that the dataset looks as expected
View(data_eye_processed)
```

```{r}
# export! we will use this dataset to merge it with the behavioral dataset (from exp_processing)

write_csv(data_eye_processed, "../data/data_eye_processed.csv")
```


