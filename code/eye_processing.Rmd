---
title: "eye_processing"
author: "Kate Petrova"
date: "2025-08-05"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE)

if(!suppressWarnings(require(pacman))){install.packages("pacman");library("pacman")}
p_load(tidyverse, tidyr, dplyr, ggplot2, stats, sjPlot, readr, ggpubr, patchwork, lubridate, ggthemr, ggdist, showtext, eyelinkReader, usethis, data.table, png, grid)
```

```{r}
# setting the theme for plots
ggthemr("fresh")
```

```{r}
# only run the first time you are using the eyelinkReader package
#usethis::edit_r_environ()
```

```{r}
# check that you are in the github directory
getwd()
```

# Single participant

```{r}
# upload data
test <- read_edf('../experiment/data/903406_regret_experiment_2025-08-06_16h07.51.977.EDF')
```

```{r}
# plot fixations using the eyelinkReader native plotting function (does not separate by routine)
plot(test, trial = NULL, show_fixations = TRUE, show_saccades = FALSE) +
    coord_cartesian(xlim = c(0, 1728), ylim = c(0, 1080)) +
  geom_vline(xintercept = 1728/2) +
  geom_hline(yintercept = 1080/2) +
  scale_y_reverse() 
```
## Data processing 

```{r}
msg  <- as.data.table(test$events)   
sac  <- as.data.table(test$saccades)    
fix  <- as.data.table(test$fixations)

msg <- msg[type == "MESSAGEEVENT" & grepl("^(FIX|CHOICE|FEEDBACK|REGRET)", message),
           .(trial, msg_time = sttime_rel, label = message)]

msg <- msg |>
    mutate(
    trial_num = as.numeric(stringr::str_extract(label, "\\d+")),
    type = case_when(
      grepl("^FIX", label) ~ "fixation",
      grepl("^CHOICE", label) ~ "choice",
      grepl("^FEEDBACK", label) ~ "feedback",
      grepl("^REGRET", label) ~ "regret",
      TRUE ~ NA_character_  
    )
  ) |>
  arrange(msg_time) |> 
  fill(type, trial_num, .direction = "down") 

sac <- sac |>
  select(sttime_rel, entime_rel, gstx, gsty, genx, geny, duration) %>% 
  rename_with(~ paste0("sac_", .))

fix <- fix |>
  select(sttime_rel, entime_rel, gstx, gsty, genx, geny, duration) %>% 
  rename_with(~ paste0("fix_", .))
  
sac[, `:=`(start = sac_sttime_rel, end = sac_entime_rel)]
msg[, `:=`(start = msg_time, end = msg_time)]
fix[, `:=`(start = fix_sttime_rel, end = fix_entime_rel)]

setkey(msg, start, end)
setkey(sac, start, end)
setkey(fix, start, end)
                     
sac_labeled <- msg[sac, on = .(start), roll = TRUE]
sac_fix_labeled <- sac_labeled[fix, on = .(start), roll = TRUE]

sac_fix_labeled <- sac_fix_labeled |>
  select(-c(trial, label, start, end, i.end, i.end.1)) |>
  filter(!is.na(msg_time)) 


```

## Data visualization

### Fixations

```{r}
# Basic bubble plot
sac_fix_labeled |>
ggplot(aes(x = fix_gstx, y = fix_gsty, size = fix_duration, color = type)) +
  coord_cartesian(xlim = c(0, 1728), ylim = c(0, 1080), expand = FALSE) +
  scale_y_reverse() +
  # geom_vline(xintercept = 1728/2) +
  # geom_hline(yintercept = 1080/2) +
  geom_point(aes(564, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(864, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(1164, 540), shape = 18, size = 4, color = "black") +
  geom_point(alpha = 0.5) +
  labs(
    title = "Fixation points",
    x = "X (pixels)", y = "Y (pixels)", size = "Duration (ms)") +
  theme(legend.position = "none") +
  facet_wrap(~ type)
```

### Saccades

```{r}
sac_fix_labeled |>
ggplot(aes(x = sac_genx, y = sac_geny, size = sac_duration, color = type)) +
  coord_cartesian(xlim = c(0, 1728), ylim = c(0, 1080), expand = FALSE) +
  scale_y_reverse() +
  # geom_vline(xintercept = 1728/2) +
  # geom_hline(yintercept = 1080/2) +
  geom_point(aes(564, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(864, 540), shape = 18, size = 4, color = "black") +
  geom_point(aes(1164, 540), shape = 18, size = 4, color = "black") +
  geom_point(alpha = 0.5) +
  labs(
    title = "Saccades end points",
    x = "X (pixels)", y = "Y (pixels)", size = "Duration (ms)") +
  theme(legend.position = "none") +
  facet_wrap(~ type)

```

# Whole sample -- IGNORE FOR NOW
```{r}
edf_files <- list.files("../data", pattern = "\\.EDF$", full.names = TRUE)

# extract participant IDs
get_pid <- function(path) {
  stringr::str_extract(basename(path), "^\\d{6}")
}

edf_data_list <- edf_files |>
  set_names(get_pid) |>
  map(~ read_edf(.x))

```


